<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evaluating a causal forest fit • grf</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Evaluating a causal forest fit">
<meta property="og:description" content="grf">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">grf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/grf.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/categorical_inputs.html">Categorical inputs</a>
    </li>
    <li>
      <a href="../articles/ci_and_num.trees.html">Confidence intervals and the number of trees</a>
    </li>
    <li>
      <a href="../articles/muhats.html">Estimating conditional means</a>
    </li>
    <li>
      <a href="../articles/diagnostics.html">Evaluating a causal forest fit</a>
    </li>
    <li>
      <a href="../articles/llf.html">Local linear forests</a>
    </li>
    <li>
      <a href="../articles/sample_weighting_examples.html">Sample weighting</a>
    </li>
    <li>
      <a href="../articles/visualize_tree.html">Visualize trees</a>
    </li>
  </ul>
</li>
<li>
  <a href="../REFERENCE.html">Algorithm reference</a>
</li>
<li>
  <a href="../DEVELOPING.html">Developing</a>
</li>
<li>
  <a href="../CHANGELOG.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/grf-labs/grf">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><link href="diagnostics_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="diagnostics_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Evaluating a causal forest fit</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/grf-labs/grf/blob/master/vignettes/diagnostics.Rmd"><code>vignettes/diagnostics.Rmd</code></a></small>
      <div class="hidden name"><code>diagnostics.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">grf</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)</pre></body></html></div>
<div id="assessing-overlap" class="section level2">
<h2 class="hasAnchor">
<a href="#assessing-overlap" class="anchor"></a>Assessing overlap</h2>
<p>Two common diagnostics to evaluate if the identifying assumptions behind grf hold is a propensity score histogram and covariance balance plot.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">2000</span>
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fl">10</span>
<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span> * <span class="no">p</span>), <span class="no">n</span>, <span class="no">p</span>)

<span class="no">W</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="no">n</span>, <span class="fl">1</span>, <span class="fl">0.4</span> + <span class="fl">0.2</span> * (<span class="no">X</span>[, <span class="fl">1</span>] <span class="kw">&gt;</span> <span class="fl">0</span>))
<span class="no">Y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="no">X</span>[, <span class="fl">1</span>], <span class="fl">0</span>) * <span class="no">W</span> + <span class="no">X</span>[, <span class="fl">2</span>] + <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>(<span class="no">X</span>[, <span class="fl">3</span>], <span class="fl">0</span>) + <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span>)
<span class="no">cf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/causal_forest.html">causal_forest</a></span>(<span class="no">X</span>, <span class="no">Y</span>, <span class="no">W</span>)</pre></body></html></div>
<p>The overlap assumption requires a positive probability of treatment for each <span class="math inline">\(X_i\)</span>. We should not be able to deterministically decide the treatment status of an individual based on its covariates, meaning none of the estimated propensity scores should be close to one or zero. One can check this with a histogram:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(<span class="no">e.hat</span> <span class="kw">&lt;-</span> <span class="no">cf</span>$<span class="no">W.hat</span>)</pre></body></html></div>
<p><img src="diagnostics_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>One can also check that the covariates are balanced across the treated and control group by plotting the inverse-propensity weighted histograms of all samples, overlaid here for each feature (done with <a href="https://ggplot2.tidyverse.org/index.html">ggplot2</a> which supports weighted histograms):</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">plot.df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">X</span>, <span class="kw">W</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">W</span>), <span class="kw">IPW</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">W</span> <span class="kw">==</span> <span class="fl">1</span>, <span class="fl">1</span> / <span class="no">e.hat</span>, <span class="fl">1</span> / (<span class="fl">1</span> - <span class="no">e.hat</span>)))
<span class="no">plot.df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html">reshape</a></span>(<span class="no">plot.df</span>, <span class="kw">varying</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">1</span>:<span class="no">p</span>), <span class="kw">v.names</span> <span class="kw">=</span> <span class="st">"X"</span>, <span class="kw">direction</span> <span class="kw">=</span> <span class="st">"long"</span>,
                   <span class="kw">times</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"X."</span>, <span class="fl">1</span>:<span class="no">p</span>), <span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"X."</span>, <span class="fl">1</span>:<span class="no">p</span>)))

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">plot.df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">X</span>, <span class="kw">weight</span> <span class="kw">=</span> <span class="no">IPW</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">W</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">position</span> <span class="kw">=</span> <span class="st">"identity"</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">30</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>( ~ <span class="no">time</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="diagnostics_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
</div>
<div id="assessing-fit" class="section level2">
<h2 class="hasAnchor">
<a href="#assessing-fit" class="anchor"></a>Assessing fit</h2>
<p>The forest summary function <a href="https://grf-labs.github.io/grf/reference/test_calibration.html">test_calibration</a> can be used to asses a forest’s goodness of fit. A coefficient of 1 for <code>mean.forest.prediction</code> suggests that the mean forest prediction is correct and a coefficient of 1 for <code>differential.forest.prediction</code> suggests that the forest has captured heterogeneity in the underlying signal.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="../reference/test_calibration.html">test_calibration</a></span>(<span class="no">cf</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Best linear fit using forest predictions (on held-out data)</span>
<span class="co">#&gt; as well as the mean forest prediction as regressors, along</span>
<span class="co">#&gt; with one-sided heteroskedasticity-robust (HC3) SEs:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                                Estimate Std. Error t value    Pr(&gt;t)    </span>
<span class="co">#&gt; mean.forest.prediction          1.01173    0.12993  7.7867  5.48e-15 ***</span>
<span class="co">#&gt; differential.forest.prediction  1.19326    0.10122 11.7885 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></pre></body></html></div>
<p>Another heuristic for testing for heterogeneity involves grouping observations into a high and low CATE group, then estimating average treatment effects in each subgroup. The function <a href="https://grf-labs.github.io/grf/reference/average_treatment_effect.html">average_treatment_effect</a> estimates ATEs using a double robust approach:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">tau.hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">cf</span>)$<span class="no">predictions</span>
<span class="no">high.effect</span> <span class="kw">&lt;-</span> <span class="no">tau.hat</span> <span class="kw">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span>(<span class="no">tau.hat</span>)
<span class="no">ate.high</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/average_treatment_effect.html">average_treatment_effect</a></span>(<span class="no">cf</span>, <span class="kw">subset</span> <span class="kw">=</span> <span class="no">high.effect</span>)
<span class="no">ate.low</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/average_treatment_effect.html">average_treatment_effect</a></span>(<span class="no">cf</span>, <span class="kw">subset</span> <span class="kw">=</span> !<span class="no">high.effect</span>)</pre></body></html></div>
<p>Which gives the following 95% confidence interval for the difference in ATE</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">ate.high</span><span class="kw">[[</span><span class="st">"estimate"</span>]] - <span class="no">ate.low</span><span class="kw">[[</span><span class="st">"estimate"</span>]] +
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">1</span>, <span class="fl">1</span>) * <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span>(<span class="fl">0.975</span>) * <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">ate.high</span><span class="kw">[[</span><span class="st">"std.err"</span>]]^<span class="fl">2</span> + <span class="no">ate.low</span><span class="kw">[[</span><span class="st">"std.err"</span>]]^<span class="fl">2</span>)
<span class="co">#&gt; [1] 0.6104840 0.9944664</span></pre></body></html></div>
<p>For more details on these two checks, see section 2.2 in Athey and Wager (2019).</p>
<p>Athey et al. (2017) suggests a bias measure to gauge how much work the propensity and outcome models have to do to get an unbiased estimate, relative to looking at a simple difference-in-means: <span class="math inline">\(bias(x) = (e(x) - p) \times (p(\mu(0, x) - \mu_0) + (1 - p) (\mu(1, x) - \mu_1)\)</span>.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">W</span>)
<span class="no">Y.hat.0</span> <span class="kw">&lt;-</span> <span class="no">cf</span>$<span class="no">Y.hat</span> - <span class="no">e.hat</span> * <span class="no">tau.hat</span>
<span class="no">Y.hat.1</span> <span class="kw">&lt;-</span> <span class="no">cf</span>$<span class="no">Y.hat</span> + (<span class="fl">1</span> - <span class="no">e.hat</span>) * <span class="no">tau.hat</span>

<span class="no">bias</span> <span class="kw">&lt;-</span> (<span class="no">e.hat</span> - <span class="no">p</span>) * (<span class="no">p</span> * (<span class="no">Y.hat.0</span> - <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">Y.hat.0</span>))  + (<span class="fl">1</span> - <span class="no">p</span>) * (<span class="no">Y.hat.1</span> - <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">Y.hat.1</span>)))</pre></body></html></div>
<p>Scaled by the standard deviation of the outcome:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(<span class="no">bias</span> / <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(<span class="no">Y</span>))</pre></body></html></div>
<p><img src="diagnostics_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>See Athey et al. (2017) section D for more details.</p>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Athey, Susan and Stefan Wager. Estimating Treatment Effects with Causal Forests: An Application. <em>Observational Studies</em>, 5, 2019. (<a href="https://arxiv.org/abs/1902.07409">arxiv</a>)</p>
<p>Athey, Susan, Guido Imbens, Thai Pham, and Stefan Wager. Estimating average treatment effects: Supplementary analyses and remaining challenges. <em>American Economic Review</em>, 107(5), May 2017: 278-281. (<a href="https://arxiv.org/abs/1702.01250">arxiv</a>)</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Julie Tibshirani, Susan Athey, Stefan Wager.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
